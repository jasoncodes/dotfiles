#!/bin/bash -e

normalize() {
  cat |
    sed '/^COPY.* FROM stdin;$/,/^\\\.$/d' |
    grep -v '^--' |
    grep . |
    tr '\n;' '\0\n' |
    sort |
    egrep -av 'CREATE( MATERIALIZED)? VIEW' |
    egrep -av 'COMMENT ON EXTENSION' |
    tr '\0\n' '\n;' |
    sed 's/;$/;\'$'\n/g'
}

SCRATCH_DIR="$(mktemp -d -t diffschema.XXXXXX)"
trap '{ rm -rf "$SCRATCH_DIR"; }' EXIT

normalize < "${1:-}" > "$SCRATCH_DIR/1.sql"
normalize < "${2:-}" > "$SCRATCH_DIR/2.sql"

vimdiff "$SCRATCH_DIR/1.sql" "$SCRATCH_DIR/2.sql"
